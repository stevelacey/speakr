<?php

/**
 * Event
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    speakr
 * @subpackage model
 * @author     Steve Lacey
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Event extends BaseEvent {
  public function getName() {
    return $this->getConference()->getName().' '.$this->getDateTimeObject('start_at')->format('Y');
  }

  public function getDate() {
    if($this->getStartDate('dmY') == $this->getEndDate('dmY')) {
      $date = $this->getStartDate('l jS F Y');
    } else if($this->getStartDate('mY') == $this->getEndDate('mY')) {
      $date = $this->getStartDate('l jS');
    } else if($this->getStartDate('Y') == $this->getEndDate('Y')) {
      $date = $this->getStartDate('l jS F');
    } else {
      $date = $this->getStartDate('l jS F Y');
    }

    if($this->getStartDate('dmY') != $this->getEndDate('dmY')) {
      $date .= '-'.$this->getEndDate('l jS F Y');
    }

    return $date;
  }

  public function getStartDate($format) {
    return $this->getDateTimeObject('start_at')->format($format);
  }

  public function getEndDate($format) {
    return $this->getDateTimeObject('end_at')->format($format);
  }

  public function getFormattedAddress() {
    return implode(', ', array(
      $this->getAddress(),
      $this->getCity(),
      $this->getRegion(),
      $this->getPostcode(),
      $this->getCountry()
    ));
  }

  public function getLocation() {
    return implode(', ', array(
      $this->getCity(),
      $this->getRegion(),
      $this->getCountry()
    ));
  }

  public function getSlug() {
    return $this->getConference()->getSlug().'-'.$this->getDateTimeObject('start_at')->format('Y');
  }

  public function getRegion() {
    return $this->getCity()->getRegion();
  }

  public function getCountry() {
    return $this->getRegion()->getCountry();
  }

  public function getSpeakersQuery() {
    return Doctrine_Query::create()->
      from('sfGuardUser u')->
      leftJoin('u.Speaker s on u.id = s.user_id')->
      leftJoin('s.Event e on s.event_id = e.id')->
      where('e.id = ?', $this->getId());
  }

  public function getSpeakersIds() {
    $ids = array();

    foreach($this->getSpeakers() as $speaker) {
      $ids[] = $speaker->getId();
    }

    return $ids;
  }

  public function hasContent(Content $content) {
    return (boolean) Doctrine_Query::create()->
      from('Event e')->
      leftJoin('e.Presentations p')->
      where('p.event_id = ?', $this->getId())->
      andWhere('p.content_id = ?', $content->getId())->
      count();
  }

  public function isUpcoming() {
    return $this->getStartDate('U') >= time();
  }

  public function isOngoing() {
    return $this->getStartDate('U') <= time() && $this->getEndDate('U') >= time();
  }

  public function isOver() {
    return $this->getEndDate('U') <= time();
  }
}